name: Manual Build and Publish DEBs Package
# run-name: Manual Build and Publish DEBs (${{ inputs.ref || github.ref_name }})
run-name: Manual Build and Publish DEBs (${{ (inputs.gh_pages == 'true' && inputs.launchpad == 'true' && 'gh_pages|launchpad ' || inputs.gh_pages == 'true' && 'gh_pages ' || inputs.launchpad == 'true' && 'launchpad ' || '') }}${{ inputs.ref }})

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git tag or branch to build from (vX.X.X)'
        required: true
        type: string
      gh_pages:
        description: 'Deploy to GitHub Pages'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      launchpad:
        description: 'Upload to Launchpad'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  actions: read

env:
  GO_VERSION: "1.22.1"
  LIBSODIUM_VERSION: "1.0.20"
  USE_BROTLI: 1
  USE_LIBSODIUM: 1
  USE_LZO: 1

jobs:
  prepare-source:
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.bin-version.outputs.VERSION }}    
    steps:
      - name: Checkout code from input ref
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
      # We download/prepare and include  source dependencies explicitly
      # because Launchpad builds run in an isolated environment without internet access,
      # so it cannot fetch anything during the build.   
      - name: Update dependencies
        run: |
          make go_deps

      # We are forced to bundle prebuilt Go archives in the package because Launchpad
      # for Ubuntu 20.04 and 22.04 provides an outdated Go version (< 1.22), while
      # our project requires Go 1.22 or higher.   
      - name: Download Golang archives
        run: |
          mkdir -p build
          wget https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz -O build/golang-amd64.tar.gz
          wget https://go.dev/dl/go${GO_VERSION}.linux-arm64.tar.gz -O build/golang-arm64.tar.gz
      
      - name: Download libsodium archive
        run: |
          mkdir -p tmp/libsodium
          curl --retry 5 --retry-delay 0 -sL "https://github.com/jedisct1/libsodium/releases/download/${LIBSODIUM_VERSION}-RELEASE/libsodium-${LIBSODIUM_VERSION}.tar.gz" -o tmp/libsodium/libsodium-${LIBSODIUM_VERSION}.tar.gz
      
      - name: Extract version
        id: bin-version
        run: |
          VERSION="${{ inputs.ref }}"
          VERSION="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
                  
      - name: Generate buildinfo file
        run: |
          echo "WALG_BUILD_DATE=$(date -u +%Y.%m.%d_%H:%M:%S)" > walg.buildinfo
          echo "WALG_GIT_REVISION=$(git rev-parse --short HEAD)" >> walg.buildinfo
          echo "WALG_VERSION=$(git tag -l --points-at HEAD)" >> walg.buildinfo
      
      - name: Create source archive
        run: |
          tar --warning=no-file-changed -czf wal_g_${VERSION}.tar.gz --exclude=.git . || true

      - name: Upload source package artifact
        uses: actions/upload-artifact@v4
        with:
          name: wal-g-source
          path: wal_g_${{ env.VERSION }}.tar.gz

  release-ubuntu-amd64:
    needs: [prepare-source]
    if: ${{ inputs.gh_pages == 'true' }}
    strategy:
      matrix:
        os: [20.04, 22.04, 24.04]
        deb_arch: [amd64]
      max-parallel: 6
      fail-fast: false
    runs-on: ubuntu-latest
    container:
      image: ubuntu:${{ matrix.os }}
    steps:
      - name: Install build dependencies
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential \
            debhelper \
            dh-golang \
            liblzo2-dev \
            brotli \
            libsodium-dev \
            cmake \
            tar \
            gzip \
            ca-certificates \
            curl \
            git \
            lsb-release
      - name: Extract version
        run: echo "VERSION=${{ needs.prepare-source.outputs.VERSION }}" >> $GITHUB_ENV

      - name: Download source package artifact
        uses: actions/download-artifact@v4
        with:
          name: wal-g-source
          path: source-artifact

      - name: Extract source archive
        run: |
          cd source-artifact
          mkdir -p source-tree
          tar xzf wal_g_${VERSION}.tar.gz -C source-tree
          echo "BUILD_DIR=$(pwd)/source-tree" >> $GITHUB_ENV

      - name: Patch debian/changelog with tag version
        run: |
          cd $BUILD_DIR
          echo "wal-g ($VERSION-1) unstable; urgency=medium" > debian/changelog
          echo "" >> debian/changelog
          echo "  * Auto-generated release for version $VERSION" >> debian/changelog
          echo "" >> debian/changelog
          echo " -- GitHub Actions <ci@example.com>  $(date -R)" >> debian/changelog

      - name: Build DEB packages
        run: |
          cd $BUILD_DIR
          dpkg-buildpackage -us -uc -b

      - name: Move DEBs to staging dir
        run: |
          mkdir -p $BUILD_DIR/output-debs
          mv $BUILD_DIR/../*.deb $BUILD_DIR/output-debs/

      - name: Rename DEBs with Ubuntu version
        run: |
          for f in $BUILD_DIR/output-debs/*.deb; do
            base=$(basename "$f" .deb)
            mv "$f" "$BUILD_DIR/output-debs/${base}_ubuntu-${{ matrix.os }}.deb"
          done

      - name: Upload DEBs
        uses: actions/upload-artifact@v4
        with:
          name: wal-g-debs-${{ matrix.os }}-${{ matrix.deb_arch }}
          path: ${{ env.BUILD_DIR }}/output-debs/*.deb
          if-no-files-found: error

  release-ubuntu-arm64:
    needs: [prepare-source]
    if: ${{ inputs.gh_pages == 'true' }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - arch: aarch64
            distro: ubuntu22.04
            label: ubuntu-22.04
            deb_arch: arm64
          - arch: aarch64
            distro: ubuntu20.04
            label: ubuntu-20.04
            deb_arch: arm64
      fail-fast: false
    steps:
      - name: Extract version
        run: echo "VERSION=${{ needs.prepare-source.outputs.VERSION }}" >> $GITHUB_ENV        
  
      - name: Download source package artifact
        uses: actions/download-artifact@v4
        with:
          name: wal-g-source
          path: source-artifact

      - name: Extract source archive
        run: |
          cd source-artifact
          mkdir -p source-tree
          tar xzf wal_g_${VERSION}.tar.gz -C source-tree
          echo "BUILD_DIR=$(pwd)/source-tree" >> $GITHUB_ENV

      - name: Patch debian/changelog with tag version
        run: |
          cd $BUILD_DIR
          echo "wal-g ($VERSION-1) unstable; urgency=medium" > debian/changelog
          echo "" >> debian/changelog
          echo "  * Auto-generated release for version $VERSION" >> debian/changelog
          echo "" >> debian/changelog
          echo " -- GitHub Actions <ci@example.com>  $(date -R)" >> debian/changelog

      - name: Build DEB packages inside ARM64 container
        uses: uraimo/run-on-arch-action@v3
        with:
          arch: ${{ matrix.arch }}
          distro: ${{ matrix.distro }}
          shell: /bin/bash
          env: |
            BUILD_DIR: ${{ env.BUILD_DIR }} 
            VERSION: ${{ env.VERSION }}
            USE_BROTLI: ${{ env.USE_BROTLI }}
            USE_LIBSODIUM: ${{ env.USE_LIBSODIUM }}
            USE_LZO: ${{ env.USE_LZO }}
          run: |
            apt-get update
            apt-get install -y build-essential cmake debhelper dh-golang \
              liblzo2-dev brotli libsodium-dev devscripts dpkg-dev

            cd $BUILD_DIR
            dpkg-buildpackage -us -uc -b

            mkdir -p output-debs
            mv ../*.deb output-debs/

            for f in output-debs/*.deb; do
              base=$(basename "$f" .deb)
              ver=$(echo "${{ matrix.distro }}" | grep -o '[0-9]\+\.[0-9]\+')
              mv "$f" "output-debs/${base}_ubuntu-${ver}.deb"
            done

      - name: Upload DEBs
        uses: actions/upload-artifact@v4
        with:
          name: wal-g-debs-${{ matrix.label }}-${{ matrix.deb_arch }}
          path: ${{ env.BUILD_DIR }}/output-debs/*.deb
          if-no-files-found: error

  deploy-to-gh-pages:
    needs: [release-ubuntu-amd64, release-ubuntu-arm64]
    if: ${{ inputs.gh_pages == 'true' }}
    runs-on: ubuntu-latest
    steps:
      # We've never had issues with `git pull`, but just in case â€” retry up to 5 times
      - name: Checkout gh-pages branch
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git clone --depth=1 --branch=gh-pages https://github.com/${{ github.repository }}.git repo-pages
          cd repo-pages
          for attempt in {1..5}; do
            git pull --rebase origin gh-pages && break
            echo "Retrying git pull ($attempt/5)..."
            sleep $(shuf -i 10-60 -n 1)
          done

      - name: Download all DEB packages
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Copy DEB files to APT repo (without public/)
        run: |
          cd repo-pages
          for deb_file in ../artifacts/*.deb; do
            echo "Processing file: $deb_file"
            if [[ "$deb_file" =~ ubuntu-([0-9]{2}\.[0-9]{2}) ]]; then
              VERSION="${BASH_REMATCH[1]}"
            else
              echo "Could not determine Ubuntu version for $deb_file"
              exit 1
            fi
            if [[ "$deb_file" =~ _amd64_ ]]; then
              ARCH="amd64"
            elif [[ "$deb_file" =~ _arm64_ ]]; then
              ARCH="arm64"
            else
              echo "Could not determine architecture for $deb_file"
              exit 1
            fi
            case "$VERSION" in
              "24.04") CODENAME="noble" ;;
              "22.04") CODENAME="jammy" ;;
              "20.04") CODENAME="focal" ;;
              *) echo "Unsupported Ubuntu version: $VERSION" && exit 1 ;;
            esac
            mkdir -p dists/$CODENAME/main/binary-arm64
            mkdir -p dists/$CODENAME/main/binary-amd64
            TARGET_DIR="dists/$CODENAME/main/binary-$ARCH"
            cp "$deb_file" "$TARGET_DIR/"
            echo "Placed $deb_file in $TARGET_DIR"
          done

      - name: Generate APT Repository Metadata
        run: |
          cd repo-pages
          for CODENAME in noble jammy focal; do
            for ARCH in amd64 arm64; do
              PACKAGE_PATH="dists/$CODENAME/main/binary-$ARCH"
              if [[ -d "$PACKAGE_PATH" && $(ls -A "$PACKAGE_PATH"/*.deb 2>/dev/null) ]]; then
                echo "Generating Packages for $CODENAME ($ARCH)"
                apt-ftparchive packages "$PACKAGE_PATH" > "$PACKAGE_PATH/Packages"
                gzip -kf "$PACKAGE_PATH/Packages"
              else
                echo "No packages found for $CODENAME ($ARCH), skipping..."
              fi
            done

            if [[ -d "dists/$CODENAME" ]]; then
              echo "Generating Release file for $CODENAME"
              apt-ftparchive \
                -o APT::FTPArchive::Release::Codename="$CODENAME" \
                -o APT::FTPArchive::Release::Origin="WAL-G Repo" \
                -o APT::FTPArchive::Release::Label="WAL-G APT Repository" \
                -o APT::FTPArchive::Release::Architectures="amd64 arm64" \
                -o APT::FTPArchive::Release::Components="main" \
                release "dists/$CODENAME" > "dists/$CODENAME/Release"
            fi
          done

      - name: Sign APT Repository Metadata
        run: |
          cd repo-pages
          export GNUPGHOME=$(mktemp -d)
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          for CODENAME in noble jammy focal; do
            echo "Signing Release file for $CODENAME..."
            gpg --batch --yes --default-key "WAL-G Repository" -abs -o dists/$CODENAME/Release.gpg dists/$CODENAME/Release
            gpg --batch --yes --default-key "WAL-G Repository" --clearsign -o dists/$CODENAME/InRelease dists/$CODENAME/Release
          done

      - name: Commit and Push Changes to gh-pages
        run: |
          cd repo-pages
          git add .
          git commit -m "Update APT repository with new packages"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          for attempt in {1..5}; do
            git push origin gh-pages && break
            echo "Retrying git push ($attempt/5)..."
            sleep $(shuf -i 1-10 -n 1)
          done

  upload-to-launchpad:
    needs: [prepare-source]
    if: ${{ inputs.launchpad == 'true' }}
    # Do not use runs-on: ubuntu-latest, you will run into issues with gpg-agent
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - codename: focal
            version: 20.04
            pretty: "Ubuntu 20.04"
          - codename: jammy
            version: 22.04
            pretty: "Ubuntu 22.04"
          - codename: noble
            version: 24.04
            pretty: "Ubuntu 24.04"
      max-parallel: 3
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper dput dpkg-dev gnupg curl

      - name: Extract version
        run: echo "VERSION=${{ needs.prepare-source.outputs.VERSION }}" >> $GITHUB_ENV
        
      - name: Download source package artifact
        uses: actions/download-artifact@v4
        with:
          name: wal-g-source
          path: source-artifact

      - name: Extract source archive
        run: |
          mkdir source-tree
          tar xzf source-artifact/wal_g_${VERSION}.tar.gz -C source-tree
          echo "BUILD_DIR=$(pwd)/source-tree" >> $GITHUB_ENV

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY_LUNCHPAD }}
        run: |
          export GNUPGHOME=$(mktemp -d)
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          echo "GNUPGHOME=$GNUPGHOME" >> $GITHUB_ENV
          GPG_KEY_ID=$(gpg --list-secret-keys --with-colons | grep '^sec' | cut -d':' -f5)
          echo "GPG_KEY_ID=$GPG_KEY_ID" >> $GITHUB_ENV
          echo "allow-loopback-pinentry" >> $GNUPGHOME/gpg-agent.conf
          echo "pinentry-mode loopback" >> $GNUPGHOME/gpg-agent.conf

      # CHANGE booster          
      - name: Patch changelog for ${{ matrix.codename }}
        run: |
          cd $BUILD_DIR
          echo "wal-g (${VERSION}-1~${{ matrix.codename }}) ${{ matrix.codename }}; urgency=medium" > debian/changelog
          echo "" >> debian/changelog
          echo "  * Initial release for ${{ matrix.pretty }}" >> debian/changelog
          echo "" >> debian/changelog
          echo " -- boosterykt <booster.ykt@gmail.com>  $(date -R)" >> debian/changelog

      - name: Build source package
        run: |
          cd $BUILD_DIR
          dpkg-buildpackage -S -d --no-sign

      - name: Sign .dsc and .changes properly
        env:
          GNUPGHOME: ${{ env.GNUPGHOME }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_KEY_ID: ${{ env.GPG_KEY_ID }}
        run: |
          cd $BUILD_DIR/..
          export GPG_TTY=$(tty)
          echo "allow-loopback-pinentry" >> $GNUPGHOME/gpg-agent.conf
          echo "pinentry-mode loopback" >> $GNUPGHOME/gpg-agent.conf
          gpgconf --kill gpg-agent

          for file in *.dsc *.changes; do
            echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback \
              --passphrase-fd 0 --default-key "$GPG_KEY_ID" \
              --output "$file.sig" --detach-sign "$file"
          done

          for file in *.dsc *.changes; do
            debsign --re-sign -k"$GPG_KEY_ID" "$file"
          done

      # Launchpad can be flaky sometimes (e.g. timeouts or 500 errors),
      # so we retry the upload up to 3 times with a delay in between.
      # CHANGE booster !!!
      - name: Upload to Launchpad (with retries)
        run: |
          cd $BUILD_DIR/..
          success=0
          for i in {1..3}; do
            echo "Attempt $i to upload..."
            if timeout 1200 dput ppa:boosterykt/wal-g wal-g_*source.changes; then
              success=1
              break
            fi            
            echo "Upload failed. Retrying within 60-120 seconds..."
            sleep $(shuf -i 60-120 -n 1)
          done

          if [ "$success" -ne 1 ]; then
            echo "All upload attempts failed. Exiting with error."
            exit 1
          fi          